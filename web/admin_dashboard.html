    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard | EduStream</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <style>
            .custom-scrollbar::-webkit-scrollbar { width: 4px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
            .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
            
            #sidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .sidebar-collapsed { width: 80px !important; }
            .sidebar-collapsed .nav-text { display: none; }
            .sidebar-collapsed .logo-text { display: none; }
            
            .nav-item-active { 
                background: #10b981; 
                color: white !important; 
                box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2);
            }

            #auth-guard {
                display: flex;
                position: fixed;
                inset: 0;
                background: white;
                z-index: 9999;
                align-items: center;
                justify-content: center;
            }
            .dark #auth-guard { background: #020617; }
        </style>
    </head>
    <body class="bg-slate-50 dark:bg-slate-950 min-h-screen text-slate-900 dark:text-slate-100 transition-colors duration-300 overflow-hidden flex">

        <!-- Auth Guard Overlay -->
        <div id="auth-guard">
            <div class="flex flex-col items-center gap-4">
                <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="font-black uppercase tracking-widest text-xs text-slate-400">Verifying Admin Privileges...</p>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col h-screen relative shrink-0">
            <div class="p-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shrink-0">
                    <span class="text-white font-black text-xl">E</span>
                </div>
                <span class="logo-text font-black text-xl tracking-tighter">Edu<span class="text-emerald-600">Portal</span></span>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto custom-scrollbar">
                <button onclick="switchTab('content')" id="nav-content" class="nav-item-active w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold text-sm">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    <span class="nav-text">Content Manager</span>
                </button>
                <button onclick="switchTab('approvals')" id="nav-approvals" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold text-sm text-left">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <div class="nav-text flex items-center justify-between w-full">
                        <span>Approvals</span>
                        <span id="badge-pending" class="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span>
                    </div>
                </button>
                <button onclick="switchTab('students')" id="nav-students" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold text-sm text-left">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    <span class="nav-text">Student Management</span>
                </button>
                <div class="h-px bg-slate-100 dark:bg-slate-800 my-4"></div>
                <a href="dashboard.html" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-slate-400 hover:text-emerald-500 transition-all font-bold text-sm">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    <span class="nav-text">Back to Student View</span>
                </a>
            </nav>

            <div class="p-4 border-t border-slate-100 dark:border-slate-800">
                <button id="sidebar-toggle" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-slate-400">
                    <svg id="toggle-icon" class="w-5 h-5 shrink-0 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    <span class="nav-text text-xs font-bold uppercase tracking-widest">Collapse Sidebar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 backdrop-blur flex items-center justify-between px-8 shrink-0">
                <h2 id="page-title" class="font-black text-sm uppercase tracking-widest text-slate-400">Content Manager</h2>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-800 border border-slate-300 dark:border-slate-700"></div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Courses</p>
                        <h3 id="stat-courses" class="text-3xl font-black">0</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Lessons</p>
                        <h3 id="stat-lessons" class="text-3xl font-black">0</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pending Requests</p>
                        <h3 id="stat-pending" class="text-3xl font-black text-amber-500">0</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Students</p>
                        <h3 id="stat-users" class="text-3xl font-black">0</h3>
                    </div>
                </div>

                <!-- Tab: Content Manager -->
                <section id="section-content" class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-black uppercase tracking-tight">Courses</h3>
                        </div>
                        <div id="course-list" class="space-y-3"></div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div id="lesson-header" class="hidden flex items-center justify-between">
                            <h3 class="text-lg font-black uppercase tracking-tight">Module Editor: <span id="selected-course-name" class="text-emerald-600">...</span></h3>
                            <button onclick="showLessonModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-xs hover:bg-emerald-700 transition flex items-center gap-2">Add New Lesson</button>
                        </div>
                        <div id="lessons-table-container" class="hidden bg-white dark:bg-slate-900 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
                                    <tr class="text-[10px] font-black uppercase text-slate-400">
                                        <th class="px-6 py-4">Module</th>
                                        <th class="px-6 py-4">Title</th>
                                        <th class="px-6 py-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="lessons-tbody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                            </table>
                        </div>
                        <div id="no-course-selected" class="h-64 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl">
                            <p class="font-bold text-sm">Select a course to edit lessons</p>
                        </div>
                    </div>
                </section>

                <!-- Tab: Approvals -->
                <section id="section-approvals" class="hidden space-y-6">
                    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-black uppercase tracking-tight">Course Enrollments</h3>
                                <p class="text-xs text-slate-400 font-bold mt-1">Showing all history: Pending, Approved, and Rejected</p>
                            </div>
                            <button onclick="loadEnrollments()" class="p-2 text-slate-400 hover:text-emerald-500 bg-slate-50 dark:bg-slate-800 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-slate-50 dark:bg-slate-800/50 text-[10px] font-black uppercase text-slate-400 border-b border-slate-100 dark:border-slate-800">
                                        <th class="px-8 py-4">Student ID</th>
                                        <th class="px-8 py-4">Course</th>
                                        <th class="px-8 py-4">Status</th>
                                        <th class="px-8 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="enrollment-tbody" class="divide-y divide-slate-100 dark:divide-slate-800 text-sm font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Tab: Student Management -->
                <section id="section-students" class="hidden space-y-6">
                    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-black uppercase tracking-tight">Student Directory</h3>
                                <p class="text-xs text-slate-400 font-bold mt-1">List of all registered students in the system</p>
                            </div>
                            <button onclick="loadStudents()" class="p-2 text-slate-400 hover:text-emerald-500 bg-slate-50 dark:bg-slate-800 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-slate-50 dark:bg-slate-800/50 text-[10px] font-black uppercase text-slate-400 border-b border-slate-100 dark:border-slate-800">
                                        <th class="px-8 py-4">Name / ID</th>
                                        <th class="px-8 py-4">Email / Info</th>
                                        <th class="px-8 py-4">Joined Date</th>
                                        <th class="px-8 py-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody" class="divide-y divide-slate-100 dark:divide-slate-800 text-sm font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Modals -->
        <!-- Lesson Modal -->
        <div id="lesson-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm" onclick="closeLessonModal()"></div>
            <div class="relative bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] shadow-2xl border border-slate-200 dark:border-slate-800 p-8">
                <h3 class="text-2xl font-black mb-6">Lesson Data</h3>
                <form id="lesson-form" class="space-y-4">
                    <input type="hidden" id="edit-lesson-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Module Name</label>
                            <input type="text" id="form-section" placeholder="Module 1" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Type</label>
                            <select id="form-type" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                                <option value="video">Video</option>
                                <option value="link">Link</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Lesson Title</label>
                        <input type="text" id="form-title" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Video ID / Resource URL</label>
                        <input type="text" id="form-url" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeLessonModal()" class="px-6 py-3 font-bold text-slate-500">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-emerald-600 text-white rounded-xl font-black">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Enrollment Status Modal -->
        <div id="enrollment-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm" onclick="closeEnrollmentModal()"></div>
            <div class="relative bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2.5rem] shadow-2xl border border-slate-200 dark:border-slate-800 p-8">
                <h3 class="text-xl font-black mb-4">Edit Enrollment</h3>
                <p id="enrollment-detail-text" class="text-xs text-slate-400 font-bold mb-6">Updating status for user...</p>
                
                <form id="enrollment-status-form" class="space-y-6">
                    <input type="hidden" id="edit-enrollment-id">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">New Status</label>
                        <select id="edit-enrollment-status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 font-bold text-sm">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <button type="submit" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-black text-sm">Update Status</button>
                        <button type="button" onclick="closeEnrollmentModal()" class="w-full py-3 font-bold text-slate-500 text-sm">Dismiss</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const CONFIG = {
                SUPABASE_URL: 'https://pkqpvnrtxtqlngwtfnhy.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrcXB2bnJ0eHRxbG5nd3Rmbmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzQxNTUsImV4cCI6MjA4NTk1MDE1NX0.wrYYlIzt1slOXkbUAqAaSI1bA9xJ2N8QhNHSRJIkZR0'
            };

            const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
            let selectedCourseId = null;

            async function checkAdmin() {
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        window.location.href = 'index.html';
                        return;
                    }

                    const { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('role')
                        .eq('id', user.id)
                        .single();

                    if (error || !profile || profile.role !== 'admin') {
                        window.location.href = 'dashboard.html';
                        return;
                    }

                    document.getElementById('auth-guard').style.display = 'none';
                    init();
                } catch (err) {
                    window.location.href = 'index.html';
                }
            }

            async function init() {
                loadStats();
                loadCourses();
                loadEnrollments();
                loadStudents();
            }

            function switchTab(tab) {
                document.getElementById('section-content').classList.toggle('hidden', tab !== 'content');
                document.getElementById('section-approvals').classList.toggle('hidden', tab !== 'approvals');
                document.getElementById('section-students').classList.toggle('hidden', tab !== 'students');
                
                document.getElementById('nav-content').classList.toggle('nav-item-active', tab === 'content');
                document.getElementById('nav-approvals').classList.toggle('nav-item-active', tab === 'approvals');
                document.getElementById('nav-students').classList.toggle('nav-item-active', tab === 'students');
                
                const titles = {
                    'content': 'Content Manager',
                    'approvals': 'Enrollment Approvals',
                    'students': 'Student Management'
                };
                document.getElementById('page-title').textContent = titles[tab];
            }

            document.getElementById('sidebar-toggle').onclick = () => {
                const sidebar = document.getElementById('sidebar');
                const icon = document.getElementById('toggle-icon');
                sidebar.classList.toggle('sidebar-collapsed');
                icon.style.transform = sidebar.classList.contains('sidebar-collapsed') ? 'rotate(180deg)' : 'rotate(0deg)';
            };

            async function loadStats() {
                const { count: cCount } = await supabaseClient.from('courses').select('*', { count: 'exact', head: true });
                const { count: lCount } = await supabaseClient.from('lessons').select('*', { count: 'exact', head: true });
                const { count: uCount } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'student');
                const { data: eData } = await supabaseClient.from('enrollments').select('status');

                const pendingCount = eData ? eData.filter(e => e.status === 'pending').length : 0;
                document.getElementById('stat-courses').textContent = cCount || 0;
                document.getElementById('stat-lessons').textContent = lCount || 0;
                document.getElementById('stat-users').textContent = uCount || 0;
                document.getElementById('stat-pending').textContent = pendingCount;
                
                const badge = document.getElementById('badge-pending');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            async function loadCourses() {
                const { data } = await supabaseClient.from('courses').select('*').order('created_at', { ascending: false });
                const list = document.getElementById('course-list');
                list.innerHTML = data.map(course => `
                    <div onclick="selectCourse('${course.id}', '${course.title}')" 
                        class="p-4 rounded-2xl cursor-pointer border-2 transition-all ${selectedCourseId === course.id ? 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/10' : 'border-transparent bg-white dark:bg-slate-900 shadow-sm hover:border-slate-200 dark:hover:border-slate-700'}">
                        <h4 class="font-black text-xs uppercase truncate">${course.title}</h4>
                    </div>
                `).join('');
            }

            async function selectCourse(id, title) {
                selectedCourseId = id;
                document.getElementById('selected-course-name').textContent = title;
                document.getElementById('no-course-selected').classList.add('hidden');
                document.getElementById('lesson-header').classList.remove('hidden');
                document.getElementById('lessons-table-container').classList.remove('hidden');
                loadCourses();
                loadLessons();
            }

            async function loadLessons() {
                const { data } = await supabaseClient.from('lessons').select('*').eq('course_id', selectedCourseId).order('section', { ascending: true });
                const tbody = document.getElementById('lessons-tbody');
                tbody.innerHTML = data.map(lesson => `
                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/30">
                        <td class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase">${lesson.section || '-'}</td>
                        <td class="px-6 py-4 font-bold text-sm">${lesson.title}</td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick='editLesson(${JSON.stringify(lesson)})' class="p-2 text-slate-400 hover:text-emerald-500 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                            <button onclick="deleteLesson('${lesson.id}')" class="p-2 text-slate-400 hover:text-red-500 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="3" class="p-8 text-center text-slate-400 italic text-sm">No lessons found.</td></tr>`;
            }

            async function loadEnrollments() {
                const { data: enrollments } = await supabaseClient.from('enrollments').select('*, courses(title)').order('created_at', { ascending: false });
                const tbody = document.getElementById('enrollment-tbody');
                
                tbody.innerHTML = enrollments.map(e => `
                    <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors">
                        <td class="px-8 py-5 text-slate-500 font-mono text-xs">${e.user_id.substring(0, 12)}...</td>
                        <td class="px-8 py-5 text-slate-700 dark:text-slate-200">${e.courses?.title || 'Unknown Course'}</td>
                        <td class="px-8 py-5">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${
                                e.status === 'approved' ? 'bg-emerald-100 text-emerald-700' : 
                                e.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'
                            }">${e.status}</span>
                        </td>
                        <td class="px-8 py-5 text-right">
                            <div class="flex justify-end items-center gap-3">
                                <button onclick='openEnrollmentEdit(${JSON.stringify(e)})' class="p-2 text-slate-400 hover:text-emerald-500 transition-colors" title="Edit Status">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <div class="w-px h-4 bg-slate-200 dark:bg-slate-800"></div>
                                <button onclick="deleteEnrollment('${e.id}')" class="p-2 text-slate-400 hover:text-red-500 transition" title="Delete Enrollment">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">No enrollment records found.</td></tr>`;
                loadStats();
            }

            async function loadStudents() {
                const { data: students, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('role', 'student')
                    .order('created_at', { ascending: false });

                const tbody = document.getElementById('students-tbody');
                if (error) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500">Error loading students.</td></tr>`;
                    return;
                }

                tbody.innerHTML = students.map(s => `
                    <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors">
                        <td class="px-8 py-5">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-black text-[10px] text-slate-400">
                                    ${s.full_name ? s.full_name.charAt(0) : '?'}
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-slate-100">${s.full_name || 'Anonymous User'}</p>
                                    <p class="text-[10px] font-mono text-slate-400">${s.id.substring(0, 12)}...</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-5">
                            <p class="text-xs text-slate-600 dark:text-slate-400 font-medium">${s.email || 'No email linked'}</p>
                            <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest mt-0.5">Role: ${s.role}</p>
                        </td>
                        <td class="px-8 py-5 text-slate-500 text-xs">
                            ${new Date(s.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-8 py-5 text-right">
                            <button onclick="alert('Management features for individual accounts coming soon.')" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-800 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 hover:text-emerald-600 rounded-lg transition text-[10px] font-black uppercase">Manage</button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">No students found in directory.</td></tr>`;
                loadStats();
            }

            // Enrollment Status Update Handling
            function openEnrollmentEdit(enrollment) {
                document.getElementById('edit-enrollment-id').value = enrollment.id;
                document.getElementById('edit-enrollment-status').value = enrollment.status;
                document.getElementById('enrollment-detail-text').textContent = `Updating status for user: ${enrollment.user_id.substring(0, 8)}... (${enrollment.courses?.title})`;
                document.getElementById('enrollment-modal').classList.remove('hidden');
            }

            function closeEnrollmentModal() {
                document.getElementById('enrollment-modal').classList.add('hidden');
                document.getElementById('enrollment-status-form').reset();
            }

            document.getElementById('enrollment-status-form').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-enrollment-id').value;
                const status = document.getElementById('edit-enrollment-status').value;
                
                const { error } = await supabaseClient
                    .from('enrollments')
                    .update({ status })
                    .eq('id', id);

                if (error) {
                    console.error("Update failed", error);
                } else {
                    closeEnrollmentModal();
                    loadEnrollments();
                }
            };

            async function deleteEnrollment(id) {
                if (confirm('Permanently delete this enrollment record?')) {
                    await supabaseClient.from('enrollments').delete().eq('id', id);
                    loadEnrollments();
                }
            }

            // Lesson Handling
            document.getElementById('lesson-form').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-lesson-id').value;
                const payload = {
                    course_id: selectedCourseId,
                    section: document.getElementById('form-section').value,
                    title: document.getElementById('form-title').value,
                    lesson_type: document.getElementById('form-type').value,
                    video_url: document.getElementById('form-url').value
                };
                if (id) await supabaseClient.from('lessons').update(payload).eq('id', id);
                else await supabaseClient.from('lessons').insert([payload]);
                closeLessonModal();
                loadLessons();
                loadStats();
            };

            function showLessonModal() { document.getElementById('lesson-modal').classList.remove('hidden'); }
            function closeLessonModal() { 
                document.getElementById('lesson-modal').classList.add('hidden'); 
                document.getElementById('lesson-form').reset(); 
                document.getElementById('edit-lesson-id').value = '';
            }
            function editLesson(l) { 
                document.getElementById('edit-lesson-id').value = l.id;
                document.getElementById('form-section').value = l.section;
                document.getElementById('form-title').value = l.title;
                document.getElementById('form-type').value = l.lesson_type;
                document.getElementById('form-url').value = l.video_url;
                showLessonModal();
            }

            async function deleteLesson(id) {
                if (confirm('Delete this lesson permanently?')) {
                    await supabaseClient.from('lessons').delete().eq('id', id);
                    loadLessons();
                    loadStats();
                }
            }

            document.getElementById('theme-toggle').onclick = () => document.documentElement.classList.toggle('dark');
            
            checkAdmin();
        </script>
    </body>
    </html>
